#!/usr/bin/env bash

release_dir="/tmp/release"
rm -rf "$release_dir"
mkdir -p "$release_dir"
cp bb "$release_dir"

VERSION=$(cat resources/BABASHKA_VERSION)


## release binary as tar.gz archive

arch=${BABASHKA_ARCH:-amd64}

if [ "$BABASHKA_STATIC" = "true" ]; then
    arch="$arch-static"
fi

# because circle won't allow the same file to be saved/restored in the same workspace concurrently
cp metabom.jar "/tmp/release/$BABASHKA_PLATFORM-$arch-metabom.jar"

cd "$release_dir"
mkdir -p /tmp/bb_size
./bb '(spit "/tmp/bb_size/size" (.length (io/file "bb")))'

archive="babashka-$VERSION-$BABASHKA_PLATFORM-$arch.tar.gz"

tar zcvf "$archive" bb # bbk

cd -

./bb --config .build/bb.edn --deps-root . release-artifact "$release_dir/$archive"

## cleanup

cd "$release_dir"
rm bb # bbk
